<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://dmenezesgabriel.github.io//assets/img/chamaleon.png">
    <title>Making a Database Handler pt.3 - Psycopg - Gabriel Menezes</title>
    <link rel="stylesheet" href="https://dmenezesgabriel.github.io//assets/css/main.css">
    <link rel="stylesheet" href="https://dmenezesgabriel.github.io//assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://dmenezesgabriel.github.io//assets/css/dracula.css">
    <script src="https://dmenezesgabriel.github.io//assets/js/all.min.js"></script>
    <script src="https://dmenezesgabriel.github.io//assets/js/jquery-3.5.1.slim.min.js"></script>
    <script src="https://dmenezesgabriel.github.io//assets/js/bootstrap.min.js"></script>
    <script src="https://dmenezesgabriel.github.io//assets/js/barToggle.js"></script>
    <script src="https://dmenezesgabriel.github.io//assets/js/searchBar.js"></script>
    <!-- Only ping google when on production environment -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-169523526-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-169523526-1');
</script>
    
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Making a Database Handler pt.3 - Psycopg | Gabriel Menezes</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Making a Database Handler pt.3 - Psycopg" />
<meta name="author" content="Gabriel Menezes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Making a Database Handler pt.3 - Psycopg" />
<meta property="og:description" content="Making a Database Handler pt.3 - Psycopg" />
<link rel="canonical" href="https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html" />
<meta property="og:url" content="https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html" />
<meta property="og:site_name" content="Gabriel Menezes" />
<meta property="og:image" content="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-18-database-handler-3/cover.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-18T11:49:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-18-database-handler-3/cover.png" />
<meta property="twitter:title" content="Making a Database Handler pt.3 - Psycopg" />
<meta name="twitter:site" content="@dmenezesgabriel" />
<meta name="twitter:creator" content="@Gabriel Menezes" />
<script type="application/ld+json">
{"datePublished":"2020-06-18T11:49:00+00:00","description":"Making a Database Handler pt.3 - Psycopg","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html"},"author":{"@type":"Person","name":"Gabriel Menezes"},"url":"https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html","image":"https://dmenezesgabriel.github.io//assets/img/posts/2020-06-18-database-handler-3/cover.png","headline":"Making a Database Handler pt.3 - Psycopg","dateModified":"2020-06-18T11:49:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>

    <div class="container-fluid fill-height bg" id="bg">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block sidebar bg-success" id="sidebar">
    <div class="sidebar-header mt-3 mb-3 text-center">
        <div class="close-btn">
            <div class="row">
                <div class="col-sm">
                    <button id="dismiss" onclick="closeNav()" class="btn close" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
            </div>
        </div>
        <h3>
            <a class="blog-name h5" href="/">Gabriel Menezes</a>
        </h3>
    </div>
    <div class="profile-section components text-center">
        <img class="profile-image mb-3" src="https://dmenezesgabriel.github.io//assets/img/profile-picture.png" alt="My image">
        <div class="bio text-center">
            <p>
                Bug developer and my father's son. Night gathers, and now my coding begins. It shall not end until I understand what I wrote at last week.
            </p>
        </div>
            <ul class="list-unstyled components text-center">

                <div class="social-list">
                    
                        <li class="list-inline-item">
                            <a href="https://github.com/dmenezesgabriel" class="list-inline py-1 mx-auto icon" target="_blank">
                                <i class="fab fa-github"></i>
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            <a href="https://twitter.com/dmenezesgabriel" class="list-inline py-1 mx-auto icon" target="_blank">
                                <i class="fab fa-twitter"></i>
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/dmenezesgabriel/" class="list-inline py-1 mx-auto icon" target="_blank">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                        </li>
                    
                </div>
                <hr>
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/portfolio/">Portfolio</a>
                </li>
                <li>
                    <a href="/about/">About</a>
                </li>
                <li>
                    <a href="/contact/">Contact</a>
                </li>
            </ul>
        </div>
</nav>

            <!-- Content -->
            <div class="col-sm pt-3 px-4" id="main">
                <nav class="navbar rounded navbar-expand-lg flex bg-white border border-success border-top-0 border-right-0 border-right-0 border-bottom-0">
  <form class="form-inline">
    <div class="input-group">
      <button type="button" id="sidebarCollapse" onclick="toggleNav()" class="btn">
          <span></span>
          <span></span>
          <span></span>
      </button>
      <input id="search" class="form-control mr-sm-2 ml-3 w-75" type="text" placeholder="Search ...">
    </div>
    </form>
  </nav>
  <div id="search-result" class="card p-3 mb-3">
  </div>
                <div class="bg-light p-3 mb-3 rounded border border-success border-top-0 border-right-0 border-right-0 border-bottom-0">
                    <div id="welcome" class="container bg-white rounded">
    <div class="text-center">
        <hr>
        <h4 class="text-dark">Welcome to Gabriel's Blog</h4>
        <hr>
    </div>
</div>
                    <div id="carouselIndicators" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
			
				
					<li data-target="#carouselIndicators" data-slide-to="0" class="active">
				
			
				
					<li data-target="#carouselIndicators" data-slide-to="1">
				
			
				
					<li data-target="#carouselIndicators" data-slide-to="2">
				
			
		</ol>

    <div class="carousel-inner rounded mb-3">
			
				
					<div class="carousel-item active">
						<div class="carousel-img">
							<img class="d-block w-100" src="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-16-database-handler-2/cover.jpg" alt="slide">
						</div>
						<div class="carousel-caption">
							<h5>Making a Database Handler pt.2 - Pipenv</h5>
							<p></p>
<p>If you already not, you should check my prev...</p>
							<a href="/python/2020/06/17/database-handler-2.html" class="btn-sm btn-success">Read</a>
						</div>
					</div>
				
			
				
					<div class="carousel-item">
						<div class="carousel-img">
							<img class="d-block w-100" src="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-18-database-handler-3/cover.png" alt="slide">
						</div>
						<div class="carousel-caption">
							<h5>Making a Database Handler pt.3 - Psycopg</h5>
							<p></p>
<p>Psycopg is a very popular database driver fo...</p>
							<a href="/python/2020/06/18/database-handler-3.html" class="btn-sm btn-success">Read</a>
						</div>
					</div>
				
			
				
					<div class="carousel-item">
						<div class="carousel-img">
							<img class="d-block w-100" src="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-24-database-handler-4/cover.jpg" alt="slide">
						</div>
						<div class="carousel-caption">
							<h5>Making a Database Handler pt.4 - GitHub</h5>
							<p>In this tutorial, I'll show you how to add an e...</p>
							<a href="/github/2020/06/24/database-handler-4.html" class="btn-sm btn-success">Read</a>
						</div>
					</div>
				
			
		</div>

    <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselIndicators" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
</div>
                </div>

            <!-- Content Goes here -->
            <div class="container">
  <div class="row">
    <div class="col-md-12 card mb-4  mt-3 left  top">
      <div class="card-body">
        <h1>Making a Database Handler pt.3 - Psycopg</h1>
        <p class="text-muted">Gabriel Menezes | Thu, Jun 18, 20</p>
        <p class="text-muted"> Last update: Thu, Jun 18, 20</p>
        <img style="width: inherit;" src="http://hits.dwyl.com/dmenezesgabriel.github.io/python/2020/06/18/database-handler-3.html.svg" alt="hit count image">
        <hr>
        <p class="card-text "></p>
<p>Psycopg is a very popular database driver for PostgreSQL databases in Python programming language, which allow us to connect to the database and perform commands programatically, with this we are able to create scripts and also improve our jupyter’s studies efficience.</p>

<div class="container p-auto mb-3 rounded-lg text-center w-50" style="background-color: black;">
  <img class="col-sm post-image rounded-lg w-100" src="https://dmenezesgabriel.github.io//assets/img/posts/2020-06-18-database-handler-3/on-the-rod-so-far.gif" alt="On the road so far supernatural">
</div>

<p>If you’re a loyal spectador who does not miss a chapter of this novel, on the road so far you’ve seen this tutorial introduction, when we start setting our <strong>PostgreSQL</strong> container with <strong>Docker</strong> and installing <strong>Pipenv</strong> to manage our packages and dependencies.</p>

<p>And a very important step, we’ve installed <strong>Psycopg2</strong>.</p>

<figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pipenv <span class="nb">install </span>psycopg2</code></pre></figure>

<p><a href="https://dmenezesgabriel.github.io/python/2020/06/17/database-handler-2.html">Previous episode - Making a Database Handler pt.2 - Docker</a></p>

<h2 id="time-to-write-the-code">Time to write the code</h2>

<p>Make some files, make some folders…</p>

<figure class="highlight"><pre><code class="language-zsh" data-lang="zsh"><span class="c"># Walk into our directory</span>
<span class="nb">cd </span>python-database-handler <span class="o">&amp;&amp;</span><span class="se">\</span>
<span class="c"># Create a file for the Database Handler</span>
code database_handler.py <span class="o">&amp;&amp;</span><span class="se">\</span>
<span class="c"># Create a file for database credentials</span>
code databases_access.json <span class="o">&amp;&amp;</span><span class="se">\</span>
<span class="c"># Create a file for our query</span>
code query.sql <span class="o">&amp;&amp;</span><span class="se">\</span>
<span class="c"># Create a file for our script</span>
code script.py</code></pre></figure>

<p>Ready, set, go! Let Sonic get some rings.</p>

<p>You don’t need to do this, it’s a plus, you will understand, but if you want you can install Pandas.</p>

<figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pipenv <span class="nb">install </span>pandas</code></pre></figure>

<p>First we’ll import some important stuff</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
</span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extras</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span></code></pre></figure>

<ul>
  <li>
<code class="language-html highlighter-rouge">json</code>: It’ll help you to deal with json data format in which we will store our database credentials.</li>
  <li>
<code class="language-html highlighter-rouge">psycopg2</code>: The driver that make possible to connect to the database programatically.</li>
  <li>
<code class="language-html highlighter-rouge">psycopg2.extras</code>: Some magic will happen here, we’ll bring the fetched results as a python dictionaries.</li>
</ul>

<p>obs: Don’t forget to jump two lines after <code class="language-html highlighter-rouge">imports</code> by the sake of pretty code. Nobody deserves the otherway.</p>

<h3 id="getting-the-credentials">Getting the credentials</h3>

<p>Simples as it not looks, the only thing that this function do is abstract the python’s built-in function to read files to a one liner.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
</span><span class="k">def</span> <span class="nf">get_database_access</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="s">"""
    Reads a file.

    Expected dict format:

    {
        "database_name": {
            "host": "database-db.host.net",
            "user": "user",
            "password": "1234",
            "database": "database_name",
            "port": 5432
        },
    }

    Parameters
    ----------
    :path: recieves access_information.json path

    Returns
    ----------
    A dictionary with databases access information
    """</span>
    <span class="n">database_file_name</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">database_file_name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_file</span><span class="p">:</span>
        <span class="n">database_access</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">database_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database_access</span></code></pre></figure>

<p>The same as above, let’s name the oxen. But this little boy is called <code class="language-html highlighter-rouge">query</code>. So what we do here? Load the query files, that is it!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
</span><span class="k">def</span> <span class="nf">load_query</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""
    Load query from .sql file

    Parameters
    ----------
    :query: file.sql path

    Returns
    ----------
    String content of query file
    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">query_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span></code></pre></figure>

<h3 id="the-man-of-the-hour-databasehandler">The man of the hour (DatabaseHandler)</h3>

<p>You got scared, I smell the fear through your armpits. This is the <code class="language-html highlighter-rouge">DatabaseHandler</code> class with all it’s attributes and methods. I’ll breakdown the code for a easier understanding.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
</span><span class="k">class</span> <span class="nc">DatabaseHandler</span><span class="p">:</span>
    <span class="s">"""
    Handler for execute queries in a given the database
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_information</span><span class="p">):</span>
        <span class="s">"""Class atributes

        Parameters
        ----------
        :access_information: databases access dictionary
        {
            "database_name": {
                "host": "database-db.host.net",
                "user": "user",
                "password": "1234",
                "database": "database_name",
                "port": 5432
            },
        }
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">access_information</span><span class="p">[</span><span class="s">"host"</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">access_information</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"port"</span><span class="p">,</span> <span class="mi">5432</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">access_information</span><span class="p">[</span><span class="s">"user"</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">access_information</span><span class="p">[</span><span class="s">"password"</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">access_information</span><span class="p">[</span><span class="s">"database"</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_connect</span><span class="p">()</span></code></pre></figure>

<p>We receive the credentials via access_information which we load by <code class="language-html highlighter-rouge">get_database_access('here_goes_the_file')</code> and define the handler attributes.</p>

<p>Furter we will need to have access to the handler’s connection, so we can reuse it and not keep opening and closing every time because this operations cost to the database execute, so once open we’ll keep it open and use for different queries.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Connection attribute
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_connection</span></code></pre></figure>

<ul>
  <li>
<code class="language-html highlighter-rouge">@property</code>: Is a <code class="language-html highlighter-rouge">decorator</code> which allow us to call a method as an attribute, among other nice stuff.</li>
</ul>

<p>Connection established houston, we’re ready to land! Below we’ve defined the function to connect to the database.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Establish connection with the database
        """</span>
        <span class="n">connection_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"host"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_host</span><span class="p">,</span>
            <span class="s">"port"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_port</span><span class="p">,</span>
            <span class="s">"dbname"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_database</span><span class="p">,</span>
            <span class="s">"user"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_user</span><span class="p">,</span>
            <span class="s">"password"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_password</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="o">**</span><span class="n">connection_parameters</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>
<code class="language-html highlighter-rouge">connect_timeout</code>: self explanatory, make good use!</li>
</ul>

<p>Our connection may fall, the method below’ll be used to an automatic reconnector!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="k">def</span> <span class="nf">_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Reconnect to database, if connection is closed
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">closed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_connect</span><span class="p">()</span></code></pre></figure>

<ul>
  <li>
<code class="language-html highlighter-rouge">closed</code>: “Read-only integer attribute: 0 if the connection is open, nonzero if it is closed or broken.”, said by psycopg docs.</li>
</ul>

<p>When you finished eating, wash your dishes and close your database connections!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Close the connection
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>We’ll reuse the same connection, but we may need another cursors. At each query we will close the cursor, so we’ll need a cursor factory!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Create cursors
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">(</span>
            <span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="p">.</span><span class="n">extras</span><span class="p">.</span><span class="n">RealDictCursor</span><span class="p">)</span></code></pre></figure>

<p>Something really cool, somethimes we may be disconnected from database by to heavy queries(don’t do that), but once we back to our sense and optimze the query it we don’t want to call the <code class="language-html highlighter-rouge">connection</code> method again, so we’ll make this automatic, intelligent and sophisticated by the use of a <code class="language-html highlighter-rouge">decorator</code> that checks if the connection is closed and reopen before making the query.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="k">def</span> <span class="nf">db_connector</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="s">"""
        Check the connection before making query,
        connect if disconnected

        Parameters
        ----------
        :func: Database related function which uses
        DatabaseHandler connection
        """</span>
        <span class="k">def</span> <span class="nf">with_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_reconnect</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">f"Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">with_connection</span></code></pre></figure>

<p>The moment we’ve all waited for, the query function! (with retries <img class="emoji" title=":heart_eyes:" alt=":heart_eyes:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60d.png" height="20" width="20">)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="o">@</span><span class="n">db_connector</span>
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="s">"""
        Fetch query results

        Parameters
        ----------
        :query: Database related function which uses
        DatabaseHandler connection
        :params: Query params
        :max_tries: Max number of query retries

        Returns
        ----------
        Query results as a list of dicts
        """</span>
        <span class="n">attempt_no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">attempt_no</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">:</span>
            <span class="n">attempt_no</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">connection</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">cursor</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">f"ERROR: In psycopg.cursor.fetchall(): </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></code></pre></figure>

<p>As I’ve said, a little bonus! Fetch the queries to a <code class="language-html highlighter-rouge">pandas</code> <code class="language-html highlighter-rouge">DataFrame</code>!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># database_handler.py
# Insider DatabaseHandler class
</span>    <span class="o">@</span><span class="n">db_connector</span>
    <span class="k">def</span> <span class="nf">query_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="s">"""
        Create a pandas DataFrame object from a query result

        Parameters
        ----------
        :sql: query statements
        :params: a list or a tuple of parameters that will
        be passed to the query execution
        :max_tries: number of query retries in the case of failure

        Returns
        ----------
        Pandas DataFrame object
        """</span>
        <span class="n">attempt_no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">attempt_no</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">attempt_no</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">connection</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">cursor</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">f"Query to DataFrame error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></code></pre></figure>

<h2 id="now-the-results-of-our-hard-work">Now the results of our hard work!</h2>

<p>The <strong>query</strong> file!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># query.sql
</span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">public</span><span class="p">.</span><span class="n">authors</span><span class="p">;</span></code></pre></figure>

<p>The <strong>script</strong> file!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># script.py
</span><span class="kn">from</span> <span class="nn">database_handler</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_database_access</span><span class="p">,</span> <span class="n">DatabaseHandler</span><span class="p">,</span> <span class="n">load_query</span>
<span class="p">)</span>

<span class="c1"># Get database credentials from json file
</span><span class="n">database_access</span> <span class="o">=</span> <span class="n">get_database_access</span><span class="p">(</span><span class="s">'databases_access.json'</span><span class="p">)</span></code></pre></figure>

<p>database_access should look like:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>{'database-test': {'database': 'postgres', 'host': 'localhost', 'password': 'postgres', 'port': 5555, 'user': 'postgres'}}
</code></pre></div></div>

<p>Instantiating the DatabaseHandler class and loading the query:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># script.py
# Instantiate the DatabaseHandler class
</span><span class="n">database_handler</span> <span class="o">=</span> <span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">database_access</span><span class="p">[</span><span class="s">"database-test"</span><span class="p">])</span>

<span class="c1"># Load a query file
</span><span class="n">query</span> <span class="o">=</span> <span class="n">load_query</span><span class="p">(</span><span class="s">'query.sql'</span><span class="p">)</span>

<span class="c1"># Fetch results
</span><span class="n">results</span> <span class="o">=</span> <span class="n">database_handler</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></code></pre></figure>

<p>Fetch query output:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>[RealDictRow([('id', 1), ('name', 'J. k. Rowling')]), RealDictRow([('id', 2), ('name', 'Stephen King')]), RealDictRow([('id', 3), ('name', 'Timothy Ferris')])]
</code></pre></div></div>

<p>For jupyter lovers this is something useful <img class="emoji" title=":thumbsup:" alt=":thumbsup:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png" height="20" width="20"></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># script.py
# Fetch results and bring them to a Pandas DataFrame
</span><span class="n">df_results</span> <span class="o">=</span> <span class="n">database_handler</span><span class="p">.</span><span class="n">query_to_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></code></pre></figure>

<p>Query to <code class="language-html highlighter-rouge">DataFrame</code> output:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>   id            name
0   1   J. k. Rowling
1   2    Stephen King
2   3  Timothy Ferris
</code></pre></div></div>

<p>Thank you for reading! <img class="emoji" title=":raised_hands:" alt=":raised_hands:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f64c.png" height="20" width="20"> <img class="emoji" title=":pray:" alt=":pray:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png" height="20" width="20"></p>

<p><a href="https://dmenezesgabriel.github.io/github/2020/06/24/database-handler-4.html">Next Episode - Making a Database Handler pt.4 - GitHub</a></p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://www.psycopg.org/docs/">Psycopg’s documentation</a></li>
</ul>

      </div>
      <div class="text-center">
  <div class="title">
    <h6 class="font-weight-bold text-dark">Share this</h6>
    <hr class="w-25">
  </div>
  <div class="social-icons">
      <a href="https://twitter.com/intent/tweet?via=dmenezesgabriel&amp;url=https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html&amp;text=Making%20a%20Database%20Handler%20pt.3%20-%20Psycopg" target="_blank">
        <i class="fab fa-twitter-square fa-2x"></i>
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html&amp;title=Making%20a%20Database%20Handler%20pt.3%20-%20Psycopg" target="_blank">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
  </div>
</div>
      <hr>
      
        <div id="disqus_thread"></div>
        <script>
        var disqus_config = function () {
        this.page.url = 'https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://dmenezesgabriel.github.io//python/2020/06/18/database-handler-3.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://dmenezesgabriel.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
      
    </div>
  </div>
</div>

        </div>
    </div>
    <script src="https://dmenezesgabriel.github.io//assets/js/dynamicBackground.js"></script>
</div></body>
</html>